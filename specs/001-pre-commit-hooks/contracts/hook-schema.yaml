# Pre-Commit Hook Configuration Schema
# This defines the contract for .pre-commit-hooks.yaml

hook_definition:
  # Required fields
  id: forbid-vars
  description: |
    Unique identifier for the hook. Used in .pre-commit-config.yaml to reference this hook.
    Format: kebab-case string
    Example: forbid-vars

  name: forbid meaningless variable names
  description: |
    Human-readable name displayed during hook execution.
    Format: lowercase sentence fragment
    Example: "forbid meaningless variable names"

  entry: forbid-vars
  description: |
    Entry point command to execute the hook.
    Format: executable name (must match pyproject.toml [project.scripts] entry)
    Example: forbid-vars
    This resolves to: pre_commit_hooks/forbid_vars.py:main

  language: python
  description: |
    Programming language of the hook implementation.
    Valid values: python, node, ruby, rust, golang, swift, system
    For this hook: python (uses Python interpreter)

  # Optional fields (using defaults appropriate for this hook)
  types: [python]
  description: |
    File types this hook should run on.
    Uses pre-commit's type detection (not file extensions).
    Default if omitted: [file] (all files)
    For this hook: [python] (only Python source files)

  # Fields intentionally NOT used (relying on defaults)
  # pass_filenames: true (default) - hook receives file paths as arguments
  # require_serial: false (default) - can run in parallel for performance
  # fail_fast: false (default) - show all violations before stopping
  # verbose: false (default) - only show output on failure
  # always_run: false (default) - only run when matching files exist
  # files: "" (default) - no additional file pattern filter
  # exclude: "^$" (default) - no exclusion pattern

# CLI Contract (argparse interface)
cli_interface:
  command: forbid-vars [OPTIONS] [FILES...]
  description: Check Python files for forbidden variable names

  positional_arguments:
    filenames:
      type: list[str]
      required: false  # Can be empty if no files match
      description: |
        List of Python file paths to check.
        Passed automatically by pre-commit framework.
        Examples:
          forbid-vars src/main.py src/utils.py
          forbid-vars  # (no files - exit 0)

  optional_arguments:
    --names:
      type: str
      default: "data,result"
      format: "name1,name2,name3"
      description: |
        Comma-separated list of forbidden variable names.
        Overrides default blacklist.
        Names are case-sensitive.
        Examples:
          --names=data,result
          --names=data,result,info,temp,obj,value

    --help / -h:
      description: Show help message and exit

# Exit Codes Contract
exit_codes:
  0:
    meaning: Success
    description: |
      All files passed validation (no forbidden names found)
      OR no files were provided to check

  1:
    meaning: Failure
    description: |
      One or more files contain forbidden variable names
      Violations were reported to stdout

  2:
    meaning: Invalid usage
    description: |
      Invalid command-line arguments
      (handled by argparse automatically)

  non_zero (other):
    meaning: Unexpected error
    description: |
      Unhandled exception occurred during execution
      (e.g., file read error, AST parse error)

# Output Contract (stdout)
output_format:
  success_output: ""
  description: |
    When all files pass (exit 0), produce NO output.
    Silent success follows Unix philosophy.

  violation_format: "{filepath}:{line}: {message}"
  description: |
    Standard linter format: file:line: message
    Enables IDE/editor integration (e.g., VS Code problem matcher)

  message_template: |
    Forbidden variable name '{name}' found. Use a more descriptive name or add '# maintainability: ignore[meaningless-variable-name]' to suppress. See https://hilton.org.uk/blog/meaningless-variable-names

  example_output: |
    src/process.py:42: Forbidden variable name 'data' found. Use a more descriptive name or add '# maintainability: ignore[meaningless-variable-name]' to suppress. See https://hilton.org.uk/blog/meaningless-variable-names
    src/process.py:51: Forbidden variable name 'result' found. Use a more descriptive name or add '# maintainability: ignore[meaningless-variable-name]' to suppress. See https://hilton.org.uk/blog/meaningless-variable-names
    tests/test_utils.py:12: Forbidden variable name 'data' found. Use a more descriptive name or add '# maintainability: ignore[meaningless-variable-name]' to suppress. See https://hilton.org.uk/blog/meaningless-variable-names

# Inline Ignore Comment Contract
ignore_comment:
  pattern: "# maintainability: ignore[meaningless-variable-name]"
  regex: '#\s*maintainability:\s*ignore\[meaningless-variable-name\]'
  case_sensitive: false
  placement: end of line containing violation
  scope: single line only

  examples:
    valid:
      - "data = load()  # maintainability: ignore[meaningless-variable-name]"
      - "result = compute()  # MAINTAINABILITY: IGNORE[MEANINGLESS-VARIABLE-NAME]"
      - "data = 1  #maintainability:ignore[meaningless-variable-name]"  # whitespace flexible

    invalid:
      - "# maintainability: ignore[meaningless-variable-name]\ndata = 1"  # wrong line
      - "data = 1  # noqa: ignore"  # wrong pattern
      - "data = 1  # maintainability: ignore"  # missing [meaningless-variable-name]

# Pre-commit Framework Integration Contract
pre_commit_integration:
  repository_url: "https://github.com/<user>/pre-commit-extra-hooks"
  description: |
    Users reference this repository in their .pre-commit-config.yaml

  example_usage: |
    # .pre-commit-config.yaml
    repos:
      - repo: https://github.com/<user>/pre-commit-extra-hooks
        rev: v1.0.0
        hooks:
          - id: forbid-vars
            # Optional: customize forbidden names
            args: ['--names=data,result,info,temp']

  hook_metadata_file: .pre-commit-hooks.yaml
  location: repository root
  format: YAML list of hook definitions

# File Processing Contract
file_processing:
  input_requirements:
    - File must be readable by the process
    - File must be syntactically valid Python (for AST parsing)
    - File encoding: UTF-8 (Python default)

  behavior:
    valid_python: |
      Parse file with ast.parse(), run visitor, report violations

    invalid_python: |
      Skip file gracefully (cannot parse AST)
      Exit code still 0 if all other files pass
      (Syntax checking is not this hook's responsibility)

    empty_file: |
      Parse succeeds (empty AST), no violations found
      Exit code 0

    binary_file: |
      Skip file (types: [python] filter prevents this)
      Pre-commit framework handles file type detection

  performance:
    complexity: O(n) where n = number of AST nodes
    target: <5 seconds for repos with <1000 files
    parallelization: Supported (require_serial: false)

# Validation Rules Contract
validation_rules:
  forbidden_variable_contexts:
    - name: Regular assignment
      ast_node: ast.Assign
      examples:
        - "data = 1"
        - "data, x = get_values()"
        - "data = x = 1"

    - name: Annotated assignment
      ast_node: ast.AnnAssign
      examples:
        - "data: int = 1"
        - "data: str"

    - name: Function parameters
      ast_node: ast.FunctionDef, ast.AsyncFunctionDef
      parameter_types:
        - Positional: "def foo(data):"
        - Positional-only: "def foo(data, /):"
        - Keyword-only: "def foo(*, data):"
        - Variable positional: "def foo(*data):"
        - Variable keyword: "def foo(**data):"
      examples:
        - "def process(data):"
        - "def get(x, *, data=None):"
        - "async def fetch(data):"

  NOT_violations:
    - Attribute access: "obj.data = 1"
    - Dictionary keys: "config['data'] = 1"
    - String literals: "message = 'the data is ready'"
    - Comments: "# get the data and process it"
    - Class names: "class DataProcessor:"
    - Function names: "def get_data():"
    - Import names: "import data_module"

# Compatibility Contract
compatibility:
  python_version: ">=3.8"
  rationale: |
    - Python 3.8+ has stable AST API
    - ast.NodeVisitor available since Python 2.6 (stable)
    - Type hints used in code (3.5+)
    - Modern syntax for better maintainability

  pre_commit_version: ">=2.0.0"
  rationale: |
    - types: [python] filter requires modern pre-commit
    - Standard hook schema widely supported

  operating_systems:
    - Linux (primary target)
    - macOS (compatible, no OS-specific code)
    - Windows (compatible with WSL/Git Bash)

  dependencies:
    runtime: []  # Python stdlib only
    development:
      - pytest (testing)
      - ruff (linting)
      - pre-commit (self-dogfooding)

# Extensibility Contract
extensibility:
  future_enhancements:
    - name: Custom ignore patterns
      description: Allow users to define their own ignore comment format
      backward_compatible: true
      implementation: Add --ignore-pattern CLI argument

    - name: Configuration file support
      description: Load forbidden names from .forbid-vars.toml
      backward_compatible: true
      implementation: Check for config file, merge with CLI args

    - name: Per-file ignore
      description: Ignore entire files via config or comment
      backward_compatible: true
      implementation: Add file-level ignore parsing

    - name: Custom error messages
      description: Allow customizing violation messages
      backward_compatible: true
      implementation: Add --message-template CLI argument

  deprecation_policy: |
    - CLI interface is stable (semver 1.0+)
    - Breaking changes require major version bump
    - Deprecated features must have 1 minor version warning period
    - Hook ID (forbid-vars) is permanent

# Testing Contract
testing_contract:
  test_categories:
    - name: Success cases
      description: Files without forbidden names exit 0
      examples:
        - Empty file
        - File with only allowed names
        - File with forbidden names in non-variable contexts

    - name: Failure cases
      description: Files with forbidden names exit 1
      examples:
        - Simple assignment: data = 1
        - Function parameter: def foo(data):
        - Multiple violations in one file

    - name: Ignore comment handling
      description: Violations suppressed by ignore comments
      examples:
        - Single line with ignore comment
        - Case-insensitive ignore pattern
        - Ignore on line with multiple variables

    - name: Edge cases
      description: Boundary conditions and unusual inputs
      examples:
        - Empty file
        - File with only comments
        - File with syntax errors
        - Binary file (should be filtered by pre-commit)
        - Very large file (performance test)

    - name: CLI argument handling
      description: Custom blacklist configuration
      examples:
        - Default blacklist (data,result)
        - Custom single name: --names=temp
        - Custom multiple names: --names=data,result,info
        - Empty blacklist: --names=  (should fail or warn)

  test_independence:
    requirement: Tests must run without git or pre-commit installed
    implementation: Invoke hook script directly with file paths
    example: python -m pre_commit_hooks.forbid_vars test_file.py

# Security Contract
security:
  threat_model: |
    Low risk - hook only reads files, performs static analysis
    No external network requests
    No arbitrary code execution
    No file modification

  file_access:
    - Reads only files passed as arguments
    - No directory traversal (pre-commit provides file list)
    - No write operations
    - Respects file permissions

  input_validation:
    - File paths: Validated by pre-commit framework
    - CLI args: Validated by argparse
    - File content: Parsed by Python ast module (safe)
    - No eval() or exec() of user input

  dependencies:
    - Zero external dependencies (Python stdlib only)
    - Reduces supply chain attack surface
    - No vulnerable transitive dependencies
